-include ../../run-make-fulldeps/tools.mk

# Make sure rlib format with -Zpacked_bundled_libs is correct.

# We're using the llvm-nm instead of the system nm to ensure it is compatible
# with the LLVM bitcode generated by rustc.
NM = "$(LLVM_BIN_DIR)"/llvm-nm

all: $(call NATIVE_STATICLIB,native_dep_1) $(call NATIVE_STATICLIB,native_dep_2) $(call NATIVE_STATICLIB,native_dep_3)
	# Build new rlibs
	$(RUSTC) rust_dep_up.rs --crate-type=rlib -Zpacked_bundled_libs
	$(NM) $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "U native_f2"
	$(NM) $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "U native_f3"
	$(NM) $(TMPDIR)/librust_dep_up.rlib | $(CGREP) -e "T.*rust_dep_up"
	$(AR) t $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "libnative_dep_2.a"
	$(AR) t $(TMPDIR)/librust_dep_up.rlib | $(CGREP) "libnative_dep_3.a"
	$(RUSTC) rust_dep_local.rs --extern rlib=$(TMPDIR)/librust_dep_up.rlib -Zpacked_bundled_libs --crate-type=rlib
	$(NM) $(TMPDIR)/librust_dep_local.rlib | $(CGREP) "U native_f1"
	$(NM) $(TMPDIR)/librust_dep_local.rlib | $(CGREP) -e "T.*rust_dep_local"
	$(AR) t $(TMPDIR)/librust_dep_local.rlib | $(CGREP) "libnative_dep_1.a"
	rm $(TMPDIR)/libnative_dep_1.a
	rm $(TMPDIR)/libnative_dep_2.a
	rm $(TMPDIR)/libnative_dep_3.a
	$(RUSTC) main.rs --extern lib=$(TMPDIR)/librust_dep_local.rlib --crate-type=bin -Zpacked_bundled_libs --print link-args | $(CGREP) -e "libnative_dep_1.a.*libnative_dep_2.a.*libnative_dep_3.a"

	# Build bin
	$(NM) $(TMPDIR)/main | $(CGREP) "T native_f1"
	$(NM) $(TMPDIR)/main | $(CGREP) "T native_f2"
	$(NM) $(TMPDIR)/main | $(CGREP) "T native_f3"
	$(NM) $(TMPDIR)/main | $(CGREP) -e "T.*rust_dep_local"
	$(NM) $(TMPDIR)/main | $(CGREP) -e "T.*rust_dep_up"
